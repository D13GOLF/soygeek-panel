<!-- templates/dashboard.html -->
{% extends "layout.html" %}
{% block content %}
<h1>Resumen General</h1>

<div class="dashboard-grid">

  <!-- Tarjeta de Clima Animada -->
  <div class="card clima-futurista">
    <h3 class="titulo-clima">ğŸŒ¤ï¸ Clima Actual</h3>
    <div id="weather-info" class="contenido-clima">
      <p>Cargando clima...</p>
    </div>
  </div>

  <!-- Tarjetas de resumen -->
  <div class="card">
      <h3>Clientes Totales</h3>
      <p>{{ clientes_count }}</p>
  </div>
  <div class="card">
      <h3>Tareas Pendientes</h3>
      <p>{{ tareas_pendientes }}</p>
  </div>
  <div class="card">
      <h3>Tareas Completadas</h3>
      <p>{{ tareas_completadas }}</p>
  </div>
  <div class="card">
      <h3>Tareas Vencidas</h3>
      <p>{{ tareas_vencidas }}</p>
  </div>
  <div class="card">
      <h3>Hostings por vencer</h3>
      <p>{{ hostings_por_vencer }}</p>
  </div>
  <div class="card">
      <h3>Estado del Bot</h3>
      <p>
          {% if estado_bot == "Activo" %}
              <span class="bot-activo">ğŸŸ¢ Activo</span>
          {% else %}
              <span class="bot-inactivo">ğŸ”´ Inactivo</span>
          {% endif %}
      </p>
  </div>
</div>

<!-- GrÃ¡fico de tareas -->
<div class="grafico-panel">
  <h3 style="text-align:center; color:#38bdf8;">ğŸ“Œ Tareas Pendientes y Completadas</h3>
  <canvas id="graficoTareas" width="400" height="200"></canvas>
</div>

<!-- GrÃ¡fico de evoluciÃ³n -->
<div class="grafico-panel">
  <h2 class="grafico-titulo">ğŸ“Š EvoluciÃ³n de Tareas Completadas</h2>
  <canvas id="graficoLineaTareas" width="500" height="200"></canvas>
</div>

<!-- GrÃ¡fico de clientes por mes -->
<div class="grafico-panel">
  <h3 style="text-align:center; color:#38bdf8;">ğŸ“† Clientes Registrados por Mes</h3>
  <canvas id="graficoClientes" width="400" height="200"></canvas>
</div>

<!-- Widget del Bot Geek -->
<div id="bot-widget" class="bot-widget">
    <div class="bot-header">
        ğŸ¤– Bot Geek
        <button onclick="toggleBot()" class="bot-close">âœ–</button>
    </div>
    <div class="bot-body" id="bot-body"></div>
    <div class="bot-input">
        <input type="text" id="bot-message" placeholder="Escribe un comando..." onkeypress="if(event.key==='Enter'){enviarMensaje()}">
        <button onclick="enviarMensaje()">Enviar</button>
    </div>
</div>

<!-- BotÃ³n flotante -->
<button class="bot-toggle" onclick="toggleBot()">ğŸ’¬ Bot Geek</button>

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // GrÃ¡fico tareas pendientes/completadas
  const ctxTareas = document.getElementById('graficoTareas').getContext('2d');
  new Chart(ctxTareas, {
    type: 'doughnut',
    data: {
      labels: ['Pendientes', 'Completadas'],
      datasets: [{
        label: 'Estado de Tareas',
        data: [{{ tareas_pendientes }}, {{ tareas_completadas }}],
        backgroundColor: ['#f59e0b', '#10b981'],
        borderWidth: 1
      }]
    },
    options: {
      plugins: {
        legend: {
          labels: {
            color: '#fff',
            font: { size: 14 }
          }
        }
      }
    }
  });

  // GrÃ¡fico lÃ­nea de tareas completadas
  const ctxLinea = document.getElementById('graficoLineaTareas').getContext('2d');
  new Chart(ctxLinea, {
    type: 'line',
    data: {
      labels: {{ meses_tareas | tojson }},
      datasets: [{
        label: 'Tareas Completadas',
        data: {{ cantidades_tareas | tojson }},
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.2)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255, 255, 255, 0.1)' }
        },
        x: {
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255, 255, 255, 0.1)' }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: '#fff',
            font: { size: 13 }
          }
        }
      }
    }
  });

  // GrÃ¡fico de clientes
  const ctxClientes = document.getElementById('graficoClientes').getContext('2d');
  new Chart(ctxClientes, {
    type: 'bar',
    data: {
      labels: {{ meses | tojson }},
      datasets: [{
        label: 'Clientes Nuevos',
        data: {{ clientes_mes | tojson }},
        backgroundColor: '#3b82f6',
        borderRadius: 6
      }]
    },
    options: {
      scales: {
        y: {
          ticks: { color: '#fff' },
          beginAtZero: true
        },
        x: {
          ticks: { color: '#fff' }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: '#38bdf8',
            font: { weight: 'bold' }
          }
        }
      }
    }
  });

  // Widget Bot
  function toggleBot() {
    const widget = document.getElementById("bot-widget");
    widget.style.display = widget.style.display === "flex" ? "none" : "flex";
  }

  function enviarMensaje() {
    const input = document.getElementById("bot-message");
    const mensaje = input.value.trim();
    if (!mensaje) return;

    const chat = document.getElementById("bot-body");
    chat.innerHTML += `<div><strong>TÃº:</strong> ${mensaje}</div>`;
    input.value = "";
    
    if (!localStorage.getItem("user_id")) {
  localStorage.setItem("user_id", crypto.randomUUID());
}
    const user_id = localStorage.getItem("user_id");
    
fetch("/api/bot", {
  method: "POST",
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ mensaje: mensaje, user_id: user_id })  // ğŸ‘ˆ Â¡Ahora enviamos el ID!
    })
    .then(response => response.json())
    .then(data => {
      chat.innerHTML += `<div><strong>Bot:</strong> ${data.respuesta}</div>`;
      chat.scrollTop = chat.scrollHeight;
    })
    .catch(error => {
      chat.innerHTML += `<div><strong>Bot:</strong> Error al contactar al bot ğŸ¤–</div>`;
    });
  }

// Clima actual para El Monte
async function cargarClima(ciudad = "El Monte,CL") {
const res = await fetch(`/api/clima?ciudad=${encodeURIComponent(ciudad)}`);
  const data = await res.json();

  if (!data.main) {
    document.getElementById('weather-info').innerHTML = `<p>âŒ No se pudo cargar el clima</p>`;
    return;
  }

  const icon = data.weather[0].icon;
  const temp = Math.round(data.main.temp);
  const estado = data.weather[0].description;
  const viento = Math.round(data.wind.speed * 3.6);
  const humedad = data.main.humidity;

  document.getElementById('weather-info').innerHTML = `
    <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${estado}" style="margin: 0 auto; display: block;">
    <p><strong>${data.name}</strong></p>
    <p>${estado.charAt(0).toUpperCase() + estado.slice(1)}</p>
    <p>ğŸŒ¡ï¸ ${temp}Â°C</p>
    <p>ğŸ’¨ Viento: ${viento} km/h</p>
    <p>ğŸ’§ Humedad: ${humedad}%</p>
  `;
}

window.addEventListener("DOMContentLoaded", () => {
  cargarClima();
});

</script>

{% endblock %}
