{% extends "layout.html" %}
{% block content %}
<h1>Resumen General</h1>
<div class="dashboard-grid">
  <!-- ğŸŒ¤ï¸ Tarjeta de Clima -->
  <div class="card clima-futurista">
    <h3 class="titulo-clima">ğŸŒ¤ï¸ Clima Actual</h3>
    <div id="weather-info" class="contenido-clima">
      <p>Cargando clima...</p>
    </div>
  </div>
<!-- Panel HologrÃ¡fico del Bot Vegeta -->
<div class="bot-holograma">
  {% if estado_bot == "Activo" %}
    <img src="{{ url_for('static', filename='img/vegeta-activo.gif') }}" alt="Bot Activo">
  {% elif estado_bot == "Pensando" %}
    <img src="{{ url_for('static', filename='img/vegeta-pensando.gif') }}" alt="Bot Pensando">
  {% else %}
    <img src="{{ url_for('static', filename='img/vegeta-inactivo.png') }}" alt="Bot Inactivo">
  {% endif %}
  <p class="estado-texto">
    {% if estado_bot == "Activo" %}
      ğŸŸ¢ Bot Operativo
    {% elif estado_bot == "Pensando" %}
      ğŸ§  Procesando orden...
    {% else %}
      ğŸ”´ Bot Apagado
    {% endif %}
  </p>
</div>
<!-- ğŸ”” Notificaciones Inteligentes -->
<div class="card notificaciones-widget">
  <h3 class="titulo-clima">ğŸ”” Notificaciones</h3>
  <ul class="notificaciones-lista">
    <li>ğŸ“¨ Tienes 2 correos pendientes</li>
    <li>â³ 1 hosting vence en 5 dÃ­as</li>
    <li>ğŸ‘¥ 3 clientes nuevos esta semana</li>
  </ul>
</div>

  </div>
  <!-- ğŸ“Š MÃ©tricas -->
  <div class="card"><h3>Clientes Totales</h3><p>{{ clientes_count }}</p></div>
  <div class="card"><h3>Tareas Pendientes</h3><p>{{ tareas_pendientes }}</p></div>
  <div class="card"><h3>Tareas Completadas</h3><p>{{ tareas_completadas }}</p></div>
  <div class="card"><h3>Tareas Vencidas</h3><p>{{ tareas_vencidas }}</p></div>
  <div class="card"><h3>Hostings por vencer</h3><p>{{ hostings_por_vencer }}</p></div>
</div>
<!-- ğŸ“ˆ GrÃ¡ficos -->
<div class="grafico-panel">
  <h3 style="text-align:center; color:#38bdf8;">ğŸ“Œ Tareas Pendientes y Completadas</h3>
  <canvas id="graficoTareas"></canvas>
</div>
<div class="grafico-panel">
  <h2 class="grafico-titulo">ğŸ“Š EvoluciÃ³n de Tareas Completadas</h2>
  <canvas id="graficoLineaTareas"></canvas>
</div>
<div class="grafico-panel">
  <h3 style="text-align:center; color:#38bdf8;">ğŸ“† Clientes Registrados por Mes</h3>
  <canvas id="graficoClientes"></canvas>
</div>
<!-- ğŸ§  Consola HologrÃ¡fica Flotante -->
<div id="asistente-consola" class="asistente-consola">
  <div class="asistente-header">ğŸ§  Vegeta AI
    <button class="asistente-cerrar" onclick="cerrarAsistente()">âœ–</button>
  </div>
  <div class="asistente-body" id="asistente-body"></div>
  <div class="asistente-input">
    <input type="text" id="asistente-comando" placeholder="Â¿QuÃ© deseas, Kakarotto?" onkeypress="if(event.key==='Enter'){enviarComando()}">
    <button onclick="enviarComando()">Enviar</button>
  </div>
</div>
<!-- BotÃ³n para abrir -->
<button class="asistente-toggle" onclick="abrirAsistente()">ğŸ§  Asistente Vegeta</button>
{% endblock %}
{% block scripts %}
<script>
  function abrirAsistente() {
    document.getElementById("asistente-consola").style.display = "flex";
  }

  function cerrarAsistente() {
    document.getElementById("asistente-consola").style.display = "none";
  }

  function enviarComando() {
    const input = document.getElementById("asistente-comando");
    const comando = input.value.trim();
    if (!comando) return;

    const consola = document.getElementById("asistente-body");
    consola.innerHTML += `<div><strong>TÃº:</strong> ${comando}</div>`;
    input.value = "";

    if (!localStorage.getItem("user_id")) {
      localStorage.setItem("user_id", crypto.randomUUID());
    }
    const user_id = localStorage.getItem("user_id");

    fetch("/api/bot", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mensaje: comando, user_id })
    })
    .then(res => res.json())
    .then(data => {
      consola.innerHTML += `<div><strong>Vegeta:</strong> ${data.respuesta}</div>`;
      consola.scrollTop = consola.scrollHeight;

      // ğŸ”Š Reproducir voz si existe
      const voz = new Audio("{{ url_for('static', filename='audio/vegeta-respuesta.mp3') }}");
      voz.play();
    })
    .catch(() => {
      consola.innerHTML += `<div><strong>Vegeta:</strong> Error al procesar el comando</div>`;
    });
  }
</script>

<audio id="bot-sonido" src="{{ url_for('static', filename='audio/jarvis.mp3') }}"></audio>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const estado = "{{ estado_bot }}";
    if (estado === "Pensando") {
      document.getElementById("bot-sonido").play();
    }
  });
</script>

<script>
  // ğŸŒ¤ï¸ Clima actual
  async function cargarClima(ciudad = "El Monte,CL") {
    try {
      const res = await fetch(`/api/clima?ciudad=${encodeURIComponent(ciudad)}`);
      const data = await res.json();

      if (!data.main) {
        document.getElementById('weather-info').innerHTML = `<p>âŒ No se pudo cargar el clima</p>`;
        return;
      }

      const icon = data.weather[0].icon;
      const temp = Math.round(data.main.temp);
      const estado = data.weather[0].description;
      const viento = Math.round(data.wind.speed * 3.6);
      const humedad = data.main.humidity;

      document.getElementById('weather-info').innerHTML = `
        <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${estado}" style="margin: 0 auto; display: block;">
        <p><strong>${data.name}</strong></p>
        <p>${estado.charAt(0).toUpperCase() + estado.slice(1)}</p>
        <p>ğŸŒ¡ï¸ ${temp}Â°C</p>
        <p>ğŸ’¨ Viento: ${viento} km/h</p>
        <p>ğŸ’§ Humedad: ${humedad}%</p>
      `;
    } catch (error) {
      console.error("âŒ Error al cargar clima:", error);
      document.getElementById('weather-info').innerHTML = `<p>âš ï¸ Error cargando clima</p>`;
    }
  }
  // âš¡ Cambiar visual del bot (con imÃ¡genes)
  function actualizarEstadoBot(estado = "activo") {
    const img = document.getElementById("img-bot-estado");
    const label = document.getElementById("label-bot-estado");

    switch (estado) {
      case "activo":
        img.src = "{{ url_for('static', filename='img/bot_vegeta_activo.png') }}";
        label.textContent = "ğŸŸ¢ Activo";
        break;
      case "inactivo":
        img.src = "{{ url_for('static', filename='img/bot_vegeta_inactivo.png') }}";
        label.textContent = "ğŸ”´ Inactivo";
        break;
      case "procesando":
        img.src = "{{ url_for('static', filename='img/bot_vegeta_procesando.png') }}";
        label.textContent = "ğŸ‘ï¸ Procesando...";
        break;
    }
  }
  // ğŸ§  LÃ³gica bot
  function enviarMensaje() {
    const input = document.getElementById("bot-message");
    const mensaje = input.value.trim();
    if (!mensaje) return;

    const chat = document.getElementById("bot-body");
    chat.innerHTML += `<div><strong>TÃº:</strong> ${mensaje}</div>`;
    input.value = "";

    if (!localStorage.getItem("user_id")) {
      localStorage.setItem("user_id", crypto.randomUUID());
    }
    const user_id = localStorage.getItem("user_id");
    
    // Mostrar "procesando"
    actualizarEstadoBot("procesando");
    fetch("/api/bot", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mensaje, user_id })
    })
    .then(res => res.json())
    .then(data => {
      chat.innerHTML += `<div><strong>Bot:</strong> ${data.respuesta}</div>`;
      chat.scrollTop = chat.scrollHeight;
      actualizarEstadoBot("activo"); // âœ… Volver a Activo
    })
    .catch(() => {
      chat.innerHTML += `<div><strong>Bot:</strong> Error al contactar al bot ğŸ¤–</div>`;
      actualizarEstadoBot("inactivo");
    });
  }

  // ğŸ“Š GrÃ¡ficos + clima al iniciar
  window.addEventListener("DOMContentLoaded", () => {
    cargarClima();

    new Chart(document.getElementById('graficoTareas'), {
      type: 'doughnut',
      data: {
        labels: ['Pendientes', 'Completadas'],
        datasets: [{
          data: [{{ tareas_pendientes }}, {{ tareas_completadas }}],
          backgroundColor: ['#f59e0b', '#10b981']
        }]
      },
      options: { plugins: { legend: { labels: { color: '#fff' } } } }
    });

    new Chart(document.getElementById('graficoLineaTareas'), {
      type: 'line',
      data: {
        labels: {{ meses_tareas | tojson }},
        datasets: [{
          label: 'Tareas Completadas',
          data: {{ cantidades_tareas | tojson }},
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.2)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        scales: {
          x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
          y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' }, beginAtZero: true }
        },
        plugins: { legend: { labels: { color: '#fff' } } }
      }
    });

    new Chart(document.getElementById('graficoClientes'), {
      type: 'bar',
      data: {
        labels: {{ meses | tojson }},
        datasets: [{
          label: 'Clientes Nuevos',
          data: {{ clientes_mes | tojson }},
          backgroundColor: '#3b82f6',
          borderRadius: 6
        }]
      },
      options: {
        scales: {
          x: { ticks: { color: '#fff' } },
          y: { ticks: { color: '#fff' }, beginAtZero: true }
        },
        plugins: {
          legend: {
            labels: { color: '#38bdf8', font: { weight: 'bold' } }
          }
        }
      }
    });
  });
</script>
{% endblock %}
