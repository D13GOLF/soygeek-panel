{% extends "layout.html" %}

{% block content %}
<h1>Resumen General</h1>

<!-- GRID PRINCIPAL -->
<div class="dashboard-grid">

  <!-- Tarjeta de Clima Futurista -->
    <div class="clima-futurista">
    <h3 class="titulo-clima">ğŸŒ¤ï¸ Clima Actual</h3>
    <div id="weather-info" class="contenido-clima">
      <p>Cargando clima...</p>
    </div>
  </div>

  <!-- Tarjetas de mÃ©tricas -->
  <div class="card"><h3>Clientes Totales</h3><p>{{ clientes_count }}</p></div>
  <div class="card"><h3>Tareas Pendientes</h3><p>{{ tareas_pendientes }}</p></div>
  <div class="card"><h3>Tareas Completadas</h3><p>{{ tareas_completadas }}</p></div>
  <div class="card"><h3>Tareas Vencidas</h3><p>{{ tareas_vencidas }}</p></div>
  <div class="card"><h3>Hostings por vencer</h3><p>{{ hostings_por_vencer }}</p></div>
  <div class="card">
    <h3>Estado del Bot</h3>
    <p>
      {% if estado_bot == "Activo" %}
        <span class="bot-activo">ğŸŸ¢ Activo</span>
      {% else %}
        <span class="bot-inactivo">ğŸ”´ Inactivo</span>
      {% endif %}
    </p>
  </div>

</div>

<!-- GrÃ¡ficos -->
<div class="grafico-panel">
  <h3 style="text-align:center; color:#38bdf8;">ğŸ“Œ Tareas Pendientes y Completadas</h3>
  <canvas id="graficoTareas" width="400" height="200"></canvas>
</div>

<div class="grafico-panel">
  <h2 class="grafico-titulo">ğŸ“Š EvoluciÃ³n de Tareas Completadas</h2>
  <canvas id="graficoLineaTareas" width="500" height="200"></canvas>
</div>

<div class="grafico-panel">
  <h3 style="text-align:center; color:#38bdf8;">ğŸ“† Clientes Registrados por Mes</h3>
  <canvas id="graficoClientes" width="400" height="200"></canvas>
</div>

<!-- Widget del Bot Geek -->
<div id="bot-widget" class="bot-widget">
  <div class="bot-header">ğŸ¤– Bot Geek
    <button onclick="toggleBot()" class="bot-close">âœ–</button>
  </div>
  <div class="bot-body" id="bot-body"></div>
  <div class="bot-input">
    <input type="text" id="bot-message" placeholder="Escribe un comando..." onkeypress="if(event.key==='Enter'){enviarMensaje()}">
    <button onclick="enviarMensaje()">Enviar</button>
  </div>
</div>

<!-- BotÃ³n flotante -->
<button class="bot-toggle" onclick="toggleBot()">ğŸ’¬ Bot Geek</button>
{% endblock %}

{% block scripts %}
<script>
  // ğŸŒ¤ï¸ Clima actual
  async function cargarClima(ciudad = "El Monte,CL") {
    try {
      const res = await fetch(`/api/clima?ciudad=${encodeURIComponent(ciudad)}`);
      const data = await res.json();

      if (!data.main) {
        document.getElementById('weather-info').innerHTML = `<p>âŒ No se pudo cargar el clima</p>`;
        return;
      }

      const icon = data.weather[0].icon;
      const temp = Math.round(data.main.temp);
      const estado = data.weather[0].description;
      const viento = Math.round(data.wind.speed * 3.6);
      const humedad = data.main.humidity;

      document.getElementById('weather-info').innerHTML = `
        <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${estado}" style="margin: 0 auto; display: block;">
        <p><strong>${data.name}</strong></p>
        <p>${estado.charAt(0).toUpperCase() + estado.slice(1)}</p>
        <p>ğŸŒ¡ï¸ ${temp}Â°C</p>
        <p>ğŸ’¨ Viento: ${viento} km/h</p>
        <p>ğŸ’§ Humedad: ${humedad}%</p>
      `;
    } catch (error) {
      console.error("âŒ Error al cargar clima:", error);
      document.getElementById('weather-info').innerHTML = `<p>âš ï¸ Error cargando clima</p>`;
    }
  }

  // ğŸ¤– Bot Widget
  function toggleBot() {
    const widget = document.getElementById("bot-widget");
    widget.style.display = widget.style.display === "flex" ? "none" : "flex";
  }

  function enviarMensaje() {
    const input = document.getElementById("bot-message");
    const mensaje = input.value.trim();
    if (!mensaje) return;

    const chat = document.getElementById("bot-body");
    chat.innerHTML += `<div><strong>TÃº:</strong> ${mensaje}</div>`;
    input.value = "";

    if (!localStorage.getItem("user_id")) {
      localStorage.setItem("user_id", crypto.randomUUID());
    }
    const user_id = localStorage.getItem("user_id");

    fetch("/api/bot", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mensaje, user_id })
    })
    .then(res => res.json())
    .then(data => {
      chat.innerHTML += `<div><strong>Bot:</strong> ${data.respuesta}</div>`;
      chat.scrollTop = chat.scrollHeight;
    })
    .catch(() => {
      chat.innerHTML += `<div><strong>Bot:</strong> Error al contactar al bot ğŸ¤–</div>`;
    });
  }

  // ğŸ“Š GrÃ¡ficos + clima al cargar
  window.addEventListener("DOMContentLoaded", () => {
    cargarClima();

    new Chart(document.getElementById('graficoTareas'), {
      type: 'doughnut',
      data: {
        labels: ['Pendientes', 'Completadas'],
        datasets: [{
          data: [{{ tareas_pendientes }}, {{ tareas_completadas }}],
          backgroundColor: ['#f59e0b', '#10b981']
        }]
      },
      options: {
        plugins: { legend: { labels: { color: '#fff' } } }
      }
    });

    new Chart(document.getElementById('graficoLineaTareas'), {
      type: 'line',
      data: {
        labels: {{ meses_tareas | tojson }},
        datasets: [{
          label: 'Tareas Completadas',
          data: {{ cantidades_tareas | tojson }},
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.2)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        scales: {
          x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
          y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' }, beginAtZero: true }
        },
        plugins: { legend: { labels: { color: '#fff' } } }
      }
    });

    new Chart(document.getElementById('graficoClientes'), {
      type: 'bar',
      data: {
        labels: {{ meses | tojson }},
        datasets: [{
          label: 'Clientes Nuevos',
          data: {{ clientes_mes | tojson }},
          backgroundColor: '#3b82f6',
          borderRadius: 6
        }]
      },
      options: {
        scales: {
          x: { ticks: { color: '#fff' } },
          y: { ticks: { color: '#fff' }, beginAtZero: true }
        },
        plugins: { legend: { labels: { color: '#38bdf8', font: { weight: 'bold' } } } }
      }
    });
  });
</script>
{% endblock %}
